# 工艺能力与稳定性 Web 应用 (Streamlit) — 集成方案

## 0) 范围 & MVP

第一阶段我们要做一个最小可行版本 (MVP)：用户可以上传数据，选择想要分析的字段，然后跑出常见的正态分布拟合，输入上下限 (LSL/USL)，得到 Cp/Cpk/Pp/Ppk 以及它们的置信区间，还能切换不同的 %OOS 计算方式（例如基于分布拟合、经验分布或者基于 SAS METHOD=3 的容忍区间）。同时配上 I–MR 控制图、Levey–Jennings 选项，以及一个简洁的统计摘要和覆盖率扫描图。第二阶段我们再扩展到非正态分布拟合、备用分布对比等。第三阶段再加入更复杂的控制图、自相关检验、结果保存与导出功能。

## 1) 技术栈与结构

我们选择 Streamlit 来做前端界面和交互，因为用户只需要浏览器就能用。数据和计算部分用 pandas、numpy、scipy、statsmodels 这些库，画图用 plotly。整个项目结构大致如下：

* `app_new.py` 是主入口，包含 Streamlit 的控件和页面布局。
* `services/capability.py` 专门放 Cp/Cpk/Pp/Ppk 的计算方法以及 %OOS 逻辑。
* `services/distributions.py` 负责分布拟合、AIC/BIC 计算和分位数函数。
* `services/control_charts.py` 画 I–MR 图以及计算控制限。
* `services/tolerance.py` 放 METHOD=3 的容忍区间算法。
* `services/oos.py` 实现 %OOS 的不同计算模式。
* `utils/validators.py` 放输入检查、缺失值校验。
* `assets/style.css` 可以加点自定义样式。

Streamlit 有内建的缓存机制，我们会用 `st.cache_data` 来避免重复计算，性能会好很多。部署可以放到 Streamlit Cloud 或者公司内网服务器。

## 2) 输入与数据模型

用户上传的数据支持 CSV 或 Excel。我们要求至少要有一列数值 (value)，可选时间戳、批次号、单位和分组字段。用户可以通过侧边栏筛选，比如按批次或者时间区间；输入 LSL/USL（可选 Target）。

> **规格逻辑总则**：仅提供 USL 或 LSL 时，后续所有计算（Cpk/Ppk、%OOS、TI 扫描）均按**单侧**逻辑执行；若同时提供 LSL 与 USL，则按**双侧**逻辑执行，图形亦只绘制对应边界。

> **注意**：本步骤**不进行分布选择**；分布的比较与选择在第 4 步完成。Sigma 来源（总体/子组内）也在第 4/5 步结合控制图/子组信息再确定。

## 3) 基础统计

系统会先展示一些描述性统计信息：样本数 n，缺失比例，平均值、中位数，标准差和 MAD，最大最小值，分位数，偏度和峰度。这些指标能帮助用户快速了解数据的整体形态。这里也会自动跑正态性检验 (Anderson–Darling)。如果样本量太小，系统会给出提醒，提示结果可能不稳。

## 4) 非正态情况

在用户看完基础统计之后，系统会提示数据的分布形态。如果数据不是正态分布，我们会在这里**同时展示**不同分布的拟合结果。为了便于比较，这些图表会以较小的尺寸并排呈现，比如正态、对数正态、威布尔、Gamma、Logistic 等。这样用户能在一眼之下看到各个分布的拟合曲线、直方图、QQ 图和 AIC/BIC 指标对比。用户可以点击某个图表放大查看细节，也能在对比表中看到每个分布的数值指标。拟合效果不佳的分布会带有“警告”徽章，提示用户结果可能不可靠。

## 5) 能力指数公式

在这一步，用户需要选择在**第 4 步**确认的分布，用来计算 Cp、Cpk、Pp、Ppk。默认直接使用第 4 步确定的最佳分布。

* **正态分布**：Ppk/Cpk 的置信区间使用**解析公式**（非 bootstrap）。代码层建议提供：

  * `analytic_ci_normal_capability(metric, n, mean, sd, LSL, USL, side)` → 返回 (点估计, CI)。
  * 解析思路：基于非中心 t / χ² 的近似解（工程常用做法）。
* **非正态分布（参数型）**：给出指数点估计；置信区间根据**拟合优度**进行调节：拟合好 → 区间更窄；拟合差 → 区间更宽并出示“谨慎解读”警示。
* **非参数（经验）**：仅提供**基于百分位的 Ppk**；置信区间采用 **bootstrap**。**Cpk 不提供**（或标注“实验性”并明确风险）。
* **单侧规格**：支持 Cpu/Ppu 或 Cpl/Ppl；双侧则输出 Cp/Cpk 与 Pp/Ppk；同时给出 **Ppk/Cpk 比值**用于短期/长期对比。
* **稳定性提示**：若第 7 步稳定性检查未通过，应在 Summary 明显提示“当前能力指标仅供诊断”。

## 6) 容忍区间 (正态, SAS METHOD=3)

**实现策略**：单侧按 METHOD=3 精确；双侧默认 Howe 近似；需要更高精度时可启用严格积分法（数值解）。

**目的**：在给定置信度 (1−α) 下，保证总体中至少有 p 的比例落在区间内；据此反推出一个保守的 %OOS（=1−p\*）。

**Python 实现细节（明确到函数与库）**

* **单侧 TI（精确法）**：基于非中心 t 分布的解析解。

  * 公式：上侧/下侧区间为 `X̄ ± g·s`，其中 g(p;n;1−α) = (1/√n) · t\_{1−α}( z\_p√n, ν=n−1 )。
  * Python：`scipy.stats.nct.ppf(1 - alpha, df=n-1, nc=norm.ppf(p) * sqrt(n))`。
  * 函数约定：`normal_ti_one_sided(x, p, alpha, side)` → `(L, U)`；同时返回 `g` 以便报告。

* **双侧 TI（工程近似，默认）**：Howe 近似（稳健、计算快）。

  * 公式：`X̄ ± k·s`，k ≈ z\_{(1+p)/2} · sqrt( ν·(1+1/n) / χ²\_{α,ν} )。
  * Python：`norm.ppf((1+p)/2)`、`scipy.stats.chi2.ppf(alpha, df=n-1)`。
  * 函数约定：`normal_ti_two_sided(x, p, alpha)` → `(L, U)`；同时返回 `k`。

* **双侧 TI（严格积分方程，可选高级模式）**：按 KM 文献的积分方程数值求解 `k`。

  * 数值：`scipy.optimize.root_scalar` + 自定义被积函数（`scipy.stats.chi2.sf`/`logsf`）或 `mpmath.quad`。
  * 函数约定：`normal_ti_two_sided_exact(x, p, alpha)` → `(L, U)`；用于需要最高精度的审计/验证场景。

**%OOS（TI 模式）**

* 覆盖率扫描：`p ∈ [0.80, 0.995]`（步长可调）。每个 `p`：

  1. 计算 TI；2) 检查 `TI ⊆ [LSL, USL]`（单侧只检查对应一侧）。
* 取使 `TI` 完全落入规格的最大 `p*`，报告 `%OOS_TI = 1 − p*`（这是在置信度 `1−α` 下的**保证**，不是分布尾概率）。
* UI：显示“覆盖率–区间边界”曲线，叠加 LSL/USL；提示框包含 `p` 与 `%OOS=1−p`。

**注意**

* 仅当数据近似正态时使用；若 AD 正态性检验提示不佳，显示“正态 TI 警告”。
* 稳定性：使用 `logsf` 处理卡方尾部；对 `(n,p,α)` 的 `k/g` 结果做缓存。
* **参数边界**：`0<p<1`、`0<α<1`；若不满足则禁用计算并给出错误提示。
* **样本量**：当 `n<10` 时，在结果旁显示“样本量偏小，区间不稳定”的提示。

## 7) %OOS / 合格率的几种算法

用户在侧边栏可以选择 %OOS 的计算方式：

1. 拟合分布（当前模型）。
2. 拟合分布（备用模型，用来对比）**（第二阶段）**。
3. 经验分布（直接数样本点落在规格外的比例）。
4. TI (正态, METHOD=3)。

如果选择 TI 模式，**直接引用第 6 步的覆盖率扫描结果**与 `p*`：界面叠加 LSL/USL 的水平参考线，并**突出显示 TI 边界与规格线的交点**（用于直观定位 `p*` 与 `%OOS=1−p*`）。

> 额外图表：**%OOS 随 Ppk 变化的曲线**。默认假设**正态、双侧对称规格、均值居中**（μ=Target）：
>
> * 双侧：`%OOS ≈ 2 · [1 − Φ(3·Ppk)]`
> * 单侧：`%OOS ≈ 1 − Φ(3·Ppk)`
>   若选择了非正态或均值偏心，可启用“按所选分布数值模拟”选项，用拟合 CDF 扫描得到曲线。

## 8) 控制图与稳定性

在第一阶段我们就会提供 I–MR 控制图，并且可以切换 Levey–Jennings 的显示方式。MVP 默认只实现最基本的异常规则（点超 3σ）。

## 9) 界面布局 (Streamlit)

* **导航方式**：采用**步骤导航（Stepper）**，按 1→8 顺序引导用户完成分析，避免信息过载。
* **侧边栏**：仅放与当前步骤相关的必要控件（如当前步骤的参数、下载按钮等），其余控件在对应步骤出现。
* **可见性**：前一步未完成时，后续步骤置灰并给出缺失项提示。

### 界面草图（按步骤向导）

```
Step 1: 上传数据
  [文件上传区] [下载模板按钮]
  数据预览表 + 列映射确认

Step 2: 基础统计
  [统计指标卡片: 样本数, 均值, 标准差, 偏度, 峰度]
  [直方图 + 正态性检验结果]

Step 3: 分布比较
  多个小卡片并排: 正态 | 对数正态 | 威布尔 | Gamma | Logistic
  每张卡片包含直方图+拟合曲线+QQ图+AIC值
  用户点击选定其中一个分布

Step 4: 能力指数
  显示 Cp/Cpk/Pp/Ppk 值及置信区间
  支持正态解析CI、非正态拟合优度调整、经验分布bootstrap
  卡片展示并附带 Ppk/Cpk 比值

Step 5: 容忍区间 & 覆盖率
  覆盖率扫描图 (横轴 p, 纵轴界限)
  单侧/双侧规格下叠加 LSL/USL 线
  tooltip显示 %OOS

Step 6: %OOS 结果
  四种模式切换: 拟合分布, 备用分布, 经验分布, TI Method=3
  对比卡片显示各自 %OOS
  额外图表: %OOS 随 Ppk 变化的函数曲线 (横轴 Ppk, 纵轴 %OOS)

Step 7: 控制图
  I–MR 图 (可选 Levey–Jennings)
  异常点可点击添加备注/原因码

Step 8: 导出
  [按钮: 下载 PDF | HTML | CSV 报告]
  报告包含封面、方法、分布、能力指数、%OOS、控制图等
```

## 10) 验收标准

比如一个正态数据集 (均值 10，标准差 1，LSL=7, USL=13)，系统算出来 Cp、Cpk、Pp、Ppk 都应该在 1.67 左右，%OOS 大概 0.27%。用 METHOD=3 算出来的 %OOS\_TI 会比拟合分布的更保守（数值更大）。

## 11) 交付与变更策略（冻结点 + 契约 + 回归）

**A. 三个前置冻结点（做完才往下走）**

* **FZ-2：数据/规格冻结**（完成第 2 步后）：确定字段映射、单/双侧规格逻辑、LOD/LOQ 处理策略（L/2｜删除｜删失拟合）。冻结后仅允许**增量**，不得改变语义。
* **FZ-5：能力与 CI 方法冻结**（完成第 5 步后）：

  * 正态 CI = 解析法（非中心 t/χ² 近似）；
  * 非正态 CI = 结合 GoF 的区间放宽；
  * 非参数 = 仅 percentile Ppk + bootstrap CI；Cpk 不提供（或标注实验性）。
* **FZ-6：TI 策略冻结**（完成第 6 步后）：单侧 = METHOD=3 精确；双侧 = Howe 近似；严格积分法为“高级模式”。

**B. 公共接口契约（第 14 节所列 API 视为稳定，不再改签名）**

* `capability_metrics(..., ci_method={analytic_normal, bootstrap, none})`
* `analytic_ci_normal_capability(...)`
* `tolerance_factor_method3_one_sided(...)` / `..._two_sided(...)`
* `compute_oos(...)` / `ti_implied_oos_from_specs(...)`

> 新功能只能**复用或封装**上述接口，不得破坏向后兼容。

**C. 配置 Schema（YAML/JSON）固定键**

```
specs: { LSL, USL, target }
distribution_selected: Normal|Lognormal|Weibull|Gamma|Logistic|Empirical
sigma_source: overall|within|subgroup
ci_method: analytic_normal|bootstrap|none
oos_method: fitted|alt_fitted|empirical|ti_method3
bootstrap: { B, seed }
ti: { p_min, p_max, p_step, alpha, mode: one|two }
subgrouping: { by: batch|time|none, size: int }
flags: { winsorize: false, censoring: none|left, lj_mode: false }
```

**D. 金标数据集 & 回归测试**

* 场景集：A 正态双侧；B 正态单侧；C 对数正态；D heavy-tail 经验法；E 小样本 n=8；F 含 LOD/LOQ 左删失。
* 对每个场景固定输出：Cp/Cpk/Pp/Ppk、四种 %OOS、TI 的 `p*`、报告元数据（B/seed/版本）。
* 将金标写入 CI，任何改动若影响金标结果即阻塞合并。

**E. 变更分级与闸门**

* **Cosmetic**（文案/样式）：可直接合并。
* **Additive**（新增分布/图表/导出字段/开关）：允许；**不得**改接口或默认行为。
* **Breaking**（改函数签名/CI或TI方法/规格逻辑）：需提交 RFC，评估对 FZ-2/5/6 的影响，并通过全部金标回归后才能合并。

**F. 开发顺序（避免返工）**

1. 先实现并单测：第 2、5、6 步（含 CI/TI 的核心计算）。
2. 再做：第 7 步四种 %OOS + “%OOS–Ppk 曲线”（先上正态假设，非正态数值模拟作为 Phase 2 开关）。
3. 最后：第 12–20 步 UI/导出/配置扩展。

**G. 可回放/复现**

* 结果与报告嵌入参数 JSON、库与版本、Git 哈希、bootstrap B 与 seed；提供一键复现命令（CLI/Python 片段）。
* 任何后续增强都能在同参数下复算出**相同结果**，避免版本争议。

## 12) 边界情况

* 如果规格不合法，会提示错误。
* 样本太少，出警告。
* 标准差=0，输出 NA。
* 有缺失值会提示并计数。
* 用户可以选择是否缩尾 (winsorize)。
* 没有规格就禁用 TI。

## 13) 开发任务

* 把四种 %OOS 算法实现出来。
* 写 METHOD=3 的 k 和 g 求解器。
* 做覆盖率扫描图。
* 加缓存避免重复算。
* 把这些逻辑接到 Streamlit 界面。

## 14) 关键函数接口

* `fit_distribution(x, name)`：拟合分布。
* `sigma_within_imr(x)`：I–MR σ。
* `sigma_within_subgroups(df, group_col)`：子组 σ。
* `capability_metrics(..., ci_method={"analytic_normal","bootstrap","none"})`：算 Cp/Cpk/Pp/Ppk，并按方法返回 CI。
* `analytic_ci_normal_capability(metric, n, mean, sd, LSL, USL, side)`：正态解析 CI。
* `compute_oos(...)`：算 %OOS。
* `tolerance_factor_method3_two_sided(n, p, conf)`：双侧 k。
* `tolerance_factor_method3_one_sided(n, p, conf)`：单侧 g。
* `ti_bounds(xbar, s, k_or_g, side)`：计算区间边界。
* `ti_implied_oos_from_specs(...)`：推导 %OOS\_TI。

## 15) 性能注意

* 提前预计算 METHOD=3 的积分节点。
* 用 logsf 避免尾部计算出错。
* k/g 值要缓存。
* 提供一个快速模式，少算点，出结果更快。

## 16) 用户操作体验

想象一个普通用户的路径：

1. 打开网页，先看到一个上传区，旁边有“下载模板”按钮，里面有示例数据。
2. 上传后，系统会自动识别列，让用户确认或修改。
3. 用户能看到数据预览表，系统会提示有多少缺失、异常值，还能一键处理。
4. 用户在侧边栏输入规格线，选好分布和 Sigma 来源。
5. 点击运行，主界面展示 Summary 卡片（Cp/Cpk/Pp/Ppk, %OOS），并且给出图表。
6. 如果过程不稳，会有明显的警告，提醒用户“先看控制图”。
7. 用户可以切换 %OOS 模式，马上看到结果对比。
8. 最后点击导出，把整个报告保存成 PDF。

## 17) 数据验证细节

上传与预处理阶段会执行以下校验与清洗，并把结果以“数据质量报告”形式展示：

* **文件与编码**：限制最大文件大小；自动探测编码（UTF-8/GBK 等），失败则提示用户手选；非法字符与不可见字符高亮。
* **字段类型**：`value` 必须是数值；`timestamp` 尝试多格式解析（支持时区）；批次与分组列做去空格与标准化。
* **缺失与异常**：统计缺失比例；检测常量列、全零列；识别极端值（箱线图/IQR、Z 分数），仅标注不默认删除。
* **样本量与间隔**：提示 `n` 是否过小；检查时间间隔异常（长断点/过密采样）。
* **LOD/LOQ 处理**：如出现 `<0.1` 等左删失值，提供三种策略：`L/2` 替代、**删除**该行、或在建模时按**左删失**处理（非参数的经验分布默认当作 `L/2`，参数分布可选删失拟合）。
* **单位与小数**：支持单位映射；数值展示统一四舍五入，小数位由规格精度与 UI 选项共同决定。
* **可追溯性**：生成数据字典与字段映射表；导出“数据质量报告（HTML/PDF）”。

---

## 18) 图表交互

* **通用交互**：悬停显示精确数值与分组信息；单击高亮/锁定；框选缩放，双击还原；支持 PNG/SVG 下载。
* **分布比较（Step 3）**：小卡片并排（直方图+拟合曲线+QQ 图+AIC）。支持调整直方图箱宽；点击某卡片即**选定分布**，卡片角标显示 AIC 与“拟合优/中/差”徽章。
* **能力指数（Step 4）**：Summary 卡片可切换 Cp/Cpk 与 Pp/Ppk；显示 Ppk/Cpk 比值与 95% CI；若稳定性未通过，卡片顶部出现**黄色警示条**。
* **Coverage/TI（Step 5）**：p-滑条联动边界曲线；叠加 LSL/USL 水平线；**高亮 TI 边界与规格线的交点**以定位 `p*`；单/双侧按规格自动切换显示；支持勾选“显示数值表”。
* **%OOS 结果（Step 6）**：同屏对比四种方法；新增 **%OOS–Ppk 曲线**：

  * 正态/对称/均值居中假设：`双侧 ≈ 2·[1−Φ(3·Ppk)]`，`单侧 ≈ 1−Φ(3·Ppk)`；
  * 勾选“按所选分布模拟”时，使用拟合 CDF 数值扫描得到曲线。
* **控制图（Step 7）**：I–MR 图支持点击异常点添加**原因码/备注**；可选择“标记但不剔除”或“排除并重算”（带**审计日志**）。
* **可访问性**：色盲友好调色板；图例可切换；自适应布局（窄屏改为 2 列/1 列）。

---

## 19) 报告导出

* **导出格式**：PDF / HTML 报告；另可导出计算结果与指标表的 CSV。
* **报告结构**：封面（项目名/日期/分析 ID/数据哈希）→ 执行摘要（关键 KPI）→ 方法说明 → 数据质量 → 分布拟合与优度 → 控制图与稳定性 → 能力指数与 %OOS → TI 覆盖率扫描 → 附录（公式与参考）。
* **元数据**：嵌入参数 JSON（规格、所选分布、CI 方法、p 扫描范围等）、库与版本信息、Git 提交哈希；**bootstrap 次数 B 与随机种子 seed**。
* **合规与可追溯**：在需要审计的环境可启用水印、页码、导出人与复核人签名区。
* **隐私**：可选择隐藏原始数据，仅保留统计与图表；或导出脱敏样本。
* **一键复现**：报告内附“复现指令片段”（CLI 或 Python 片段），便于离线重算。

---

## 20) 可配置选项

* **统计/计算**：小数位；抽样比例；`alpha`（CI 置信度）；bootstrap 次数 B 与 seed；AIC 阈值；候选分布池；是否启用删失拟合；winsorize 比例；robust σ（MAD→σ）开关；`ci_method={analytic_normal, bootstrap, none}`。
* **TI/覆盖率**：p 扫描范围与步长；单/双侧自动；Howe/严格积分法开关。
* **控制图**：Nelson 规则灵敏度；排除点的策略（仅标记/重算）；最小子组大小；自动分组规则。
* **UI/导出**：主题与配色；图表分辨率；是否显示徽章与警示条；报告水印与签名区；语言（中文/英文）；表格千分位与单位。
* **性能**：开启/关闭缓存；快速/精确模式；最大绘图点数（大数据自动抽样）。
* **时间/分组**：时区解析；时间聚合粒度（日/周/批次）；按分组/批次分层计算能力指数。

